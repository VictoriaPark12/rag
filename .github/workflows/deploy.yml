name: Deploy to EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushë  ë•Œë§ˆë‹¤ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ê°€ëŠ¥
    inputs:
      git_ref:
        description: "Git branch/tag/commit to deploy (manual only)"
        required: false
        default: "main"
        type: string
      skip_tests:
        description: "Skip tests (manual only)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

# Docker ì—†ì´ ì§ì ‘ ë°°í¬

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          cd app
          pytest tests/unit_tests -v --cov=. --cov-report=term-missing || echo "No tests found, skipping..."

  deploy:
    name: Deploy to EC2
    needs: test  # í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ì—ë§Œ ë°°í¬
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "âŒ ERROR: EC2_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ ERROR: EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "$EC2_USER" ]; then
            echo "âŒ ERROR: EC2_USER secret is not set"
            exit 1
          fi

          echo "ğŸ”§ Configuring SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH í‚¤ ì €ì¥ (ê°œí–‰ ë¬¸ì ë³´ì¡´)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # EC2_HOST ê°’ í™•ì¸ ë° ê²€ì¦
          echo "ğŸ” EC2_HOST ê°’ í™•ì¸: ${EC2_HOST:0:20}..."  # ì²˜ìŒ 20ìë§Œ ì¶œë ¥ (ë³´ì•ˆ)
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ ERROR: EC2_HOST ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
            exit 1
          fi

          # known_hostsì— í˜¸ìŠ¤íŠ¸ ì¶”ê°€
          echo "ğŸ”§ Adding host to known_hosts..."
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "âš ï¸  Warning: ssh-keyscan failed, but continuing..."
          }

          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸ (íƒ€ì„ì•„ì›ƒ 5ì´ˆë¡œ ë‹¨ì¶•)
          echo "ğŸ” Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o BatchMode=yes "$EC2_USER@$EC2_HOST" "echo 'SSH connection successful'" || {
            echo "âš ï¸  WARNING: SSH connection test failed (this may be due to security group settings)"
            echo "â„¹ï¸  Continuing anyway - deployment will attempt to connect..."
          }

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: /opt/langchain  # <-- Secrets ëŒ€ì‹  ì§ì ‘ ê³ ì •
        run: |
          echo "Deploying to: $DEPLOY_PATH"
          SSH_KEY_PATH=~/.ssh/deploy_key ./scripts/deploy_to_ec2.sh

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" bash -s << ENDSSH
            set -e

            DEPLOY_PATH="$DEPLOY_PATH"
            echo "ğŸš€ Starting deployment to: \$DEPLOY_PATH"

            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±)
            if [ ! -d "\$DEPLOY_PATH" ]; then
              echo "ğŸ“ Creating deploy directory: \$DEPLOY_PATH"
              sudo mkdir -p "\$DEPLOY_PATH"
              sudo chown \$USER:\$USER "\$DEPLOY_PATH"
            fi
            cd "\$DEPLOY_PATH"
            echo "ğŸ“‚ Current directory: \$(pwd)"

            # ê¸°ì¡´ ë³€ê²½ì‚¬í•­ ë°±ì—… (í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°)
            git stash || true

            # ìµœì‹  ì½”ë“œ pull (push: main, manual: ì…ë ¥ ref)
            REF="${{ github.event.inputs.git_ref }}"
            if [ -z "$REF" ]; then REF="main"; fi
            git fetch --all --tags
            git checkout "$REF"
            git pull origin "$REF" || true

            # .env íŒŒì¼ ì¡´ì¬ í™•ì¸ (ì—†ìœ¼ë©´ ì—ëŸ¬)
            if [ ! -f .env ]; then
              echo "âŒ ERROR: .env file not found!"
              exit 1
            fi

            # Python ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
            if [ ! -d venv ]; then
              echo "ğŸ“¦ Creating Python virtual environment..."
              python3.11 -m venv venv
            fi

            # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ Installing dependencies..."
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r app/requirements.txt

            # systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            echo "ğŸ”„ Restarting langchain-backend service..."
            sudo systemctl daemon-reload
            sudo systemctl restart langchain-backend

            # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
            echo "â³ Waiting for service to be healthy..."
            sleep 10

            # ë°±ì—”ë“œ ìƒíƒœ í™•ì¸
            if sudo systemctl is-active --quiet langchain-backend; then
              echo "âœ… Backend service is running"
              sudo journalctl -u langchain-backend --no-pager -n 50
            else
              echo "âŒ Backend service failed to start"
              sudo journalctl -u langchain-backend --no-pager -n 100
              exit 1
            fi

            # API í—¬ìŠ¤ì²´í¬
            for i in {1..30}; do
              if curl -f http://localhost:8000/docs > /dev/null 2>&1; then
                echo "âœ… API is healthy!"
                break
              fi
              echo "â³ Waiting for API... ($i/30)"
              sleep 2
            done

            echo "ğŸ‰ Deployment completed successfully!"
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment succeeded"
          else
            echo "âŒ Deployment failed"
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

