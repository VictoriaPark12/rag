name: Deploy to EC2

on:
  push:
    branches:
      - main  # main Î∏åÎûúÏπòÏóê pushÎê† ÎïåÎßàÎã§ Î∞∞Ìè¨
  workflow_dispatch:  # ÏàòÎèô Ìä∏Î¶¨Í±∞ Í∞ÄÎä•
    inputs:
      git_ref:
        description: "Git branch/tag/commit to deploy (manual only)"
        required: false
        default: "main"
        type: string
      skip_tests:
        description: "Skip tests (manual only)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

# Docker ÏóÜÏù¥ ÏßÅÏ†ë Î∞∞Ìè¨

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          cd app
          pytest tests/unit_tests -v --cov=. --cov-report=term-missing || echo "No tests found, skipping..."

  deploy:
    name: Deploy to EC2
    needs: test  # ÌÖåÏä§Ìä∏ ÌÜµÍ≥º ÌõÑÏóêÎßå Î∞∞Ìè¨
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # ÌôòÍ≤Ω Î≥ÄÏàò Í≤ÄÏ¶ù
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "‚ùå ERROR: EC2_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå ERROR: EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "$EC2_USER" ]; then
            echo "‚ùå ERROR: EC2_USER secret is not set"
            exit 1
          fi

          echo "üîß Configuring SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH ÌÇ§ Ï†ÄÏû• (Í∞úÌñâ Î¨∏Ïûê Î≥¥Ï°¥)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # EC2_HOST Í∞í ÌôïÏù∏ Î∞è Í≤ÄÏ¶ù
          echo "üîç EC2_HOST Í∞í ÌôïÏù∏: ${EC2_HOST:0:20}..."  # Ï≤òÏùå 20ÏûêÎßå Ï∂úÎ†• (Î≥¥Ïïà)
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå ERROR: EC2_HOST Í∞íÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§"
            exit 1
          fi

          # known_hostsÏóê Ìò∏Ïä§Ìä∏ Ï∂îÍ∞Ä
          echo "üîß Adding host to known_hosts..."
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è  Warning: ssh-keyscan failed, but continuing..."
          }

          # SSH Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ (ÌÉÄÏûÑÏïÑÏõÉ 5Ï¥àÎ°ú Îã®Ï∂ï)
          echo "üîç Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o BatchMode=yes "$EC2_USER@$EC2_HOST" "echo 'SSH connection successful'" || {
            echo "‚ö†Ô∏è  WARNING: SSH connection test failed (this may be due to security group settings)"
            echo "‚ÑπÔ∏è  Continuing anyway - deployment will attempt to connect..."
          }

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: /opt/langchain
        run: |
          echo "Deploying to: $DEPLOY_PATH"
          chmod +x scripts/deploy_to_ec2.sh
          SSH_KEY_PATH=~/.ssh/deploy_key bash scripts/deploy_to_ec2.sh

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment succeeded"
          else
            echo "‚ùå Deployment failed"
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

