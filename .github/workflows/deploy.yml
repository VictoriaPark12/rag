name: Deploy to EC2

on:
  push:
    branches:
      - main  # main Î∏åÎûúÏπòÏóê pushÎê† ÎïåÎßàÎã§ Î∞∞Ìè¨
  workflow_dispatch:  # ÏàòÎèô Ìä∏Î¶¨Í±∞ Í∞ÄÎä•
    inputs:
      git_ref:
        description: "Git branch/tag/commit to deploy (manual only)"
        required: false
        default: "main"
        type: string
      skip_tests:
        description: "Skip tests (manual only)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

# Docker ÏóÜÏù¥ ÏßÅÏ†ë Î∞∞Ìè¨

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # OpenAI Í¥ÄÎ†® ÏùòÏ°¥ÏÑ±Îßå ÏÑ§Ïπò
          pip install langchain-openai>=0.0.5
          pip install python-dotenv>=1.0.0
          pip install fastapi>=0.104.0
          pip install uvicorn[standard]>=0.24.0
          pip install pytest pytest-cov
          echo "‚úÖ Dependencies installed for OpenAI integration"

      - name: Verify openai folder structure
        run: |
          echo "üîç Verifying openai folder structure..."
          if [ -d "openai" ]; then
            echo "‚úÖ openai folder exists"
            if [ -f "openai/app/core/llm/openai.py" ]; then
              echo "‚úÖ openai.py file found"
            else
              echo "‚ùå openai.py file not found"
              exit 1
            fi
          else
            echo "‚ùå openai folder not found"
            exit 1
          fi

  deploy:
    name: Deploy to EC2
    needs: test  # ÌÖåÏä§Ìä∏ ÌÜµÍ≥º ÌõÑÏóêÎßå Î∞∞Ìè¨
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # ÌôòÍ≤Ω Î≥ÄÏàò Í≤ÄÏ¶ù
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "‚ùå ERROR: EC2_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå ERROR: EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "$EC2_USER" ]; then
            echo "‚ùå ERROR: EC2_USER secret is not set"
            exit 1
          fi

          echo "üîß Configuring SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH ÌÇ§ Ï†ÄÏû• (Í∞úÌñâ Î¨∏Ïûê Î≥¥Ï°¥)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # EC2_HOST Í∞í ÌôïÏù∏ Î∞è Í≤ÄÏ¶ù
          echo "üîç EC2_HOST Í∞í ÌôïÏù∏: ${EC2_HOST:0:20}..."  # Ï≤òÏùå 20ÏûêÎßå Ï∂úÎ†• (Î≥¥Ïïà)
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå ERROR: EC2_HOST Í∞íÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§"
            exit 1
          fi

          # known_hostsÏóê Ìò∏Ïä§Ìä∏ Ï∂îÍ∞Ä
          echo "üîß Adding host to known_hosts..."
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è  Warning: ssh-keyscan failed, but continuing..."
          }

          # SSH Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ (ÌÉÄÏûÑÏïÑÏõÉ 5Ï¥àÎ°ú Îã®Ï∂ï)
          echo "üîç Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o BatchMode=yes "$EC2_USER@$EC2_HOST" "echo 'SSH connection successful'" || {
            echo "‚ö†Ô∏è  WARNING: SSH connection test failed (this may be due to security group settings)"
            echo "‚ÑπÔ∏è  Continuing anyway - deployment will attempt to connect..."
          }

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: /opt/langchain
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Deploying to: $DEPLOY_PATH"
          # OPENAI_API_KEY ÌôïÏù∏ (Î≥¥ÏïàÏùÑ ÏúÑÌï¥ ÏùºÎ∂ÄÎßå Ï∂úÎ†•)
          if [ -n "$OPENAI_API_KEY" ]; then
            KEY_PREVIEW="${OPENAI_API_KEY:0:10}...${OPENAI_API_KEY: -4}"
            echo "‚úÖ OPENAI_API_KEY found in secrets (preview: $KEY_PREVIEW)"
          else
            echo "‚ö†Ô∏è  WARNING: OPENAI_API_KEY not found in GitHub Secrets"
            echo "   The deployment script will check for it in EC2's .env file"
          fi
          chmod +x scripts/deploy_to_ec2.sh
          SSH_KEY_PATH=~/.ssh/deploy_key bash scripts/deploy_to_ec2.sh

      - name: Verify openai folder deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: /opt/langchain
        run: |
          echo "üîç Verifying openai folder deployment..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" << ENDSSH
            DEPLOY_PATH="/opt/langchain"
            if [ -d "\$DEPLOY_PATH/openai" ]; then
              echo "‚úÖ openai folder exists"
              if [ -f "\$DEPLOY_PATH/openai/app/core/llm/openai.py" ]; then
                echo "‚úÖ openai.py file found"
                if [ -f "\$DEPLOY_PATH/openai/__init__.py" ]; then
                  echo "‚úÖ openai/__init__.py found"
                  if [ -f "\$DEPLOY_PATH/openai/app/__init__.py" ]; then
                    echo "‚úÖ openai/app/__init__.py found"
                    if [ -f "\$DEPLOY_PATH/openai/app/core/__init__.py" ]; then
                      echo "‚úÖ openai/app/core/__init__.py found"
                      if [ -f "\$DEPLOY_PATH/openai/app/core/llm/__init__.py" ]; then
                        echo "‚úÖ openai/app/core/llm/__init__.py found"
                        echo "‚úÖ openai folder structure is correct"
                      else
                        echo "‚ö†Ô∏è  openai/app/core/llm/__init__.py not found"
                      fi
                    else
                      echo "‚ö†Ô∏è  openai/app/core/__init__.py not found"
                    fi
                  else
                    echo "‚ö†Ô∏è  openai/app/__init__.py not found"
                  fi
                else
                  echo "‚ö†Ô∏è  openai/__init__.py not found"
                fi
              else
                echo "‚ùå openai.py file not found"
                exit 1
              fi
            else
              echo "‚ùå openai folder not found"
              exit 1
            fi
          ENDSSH

      - name: Restart Backend Service
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: /opt/langchain
        run: |
          echo "üîÑ Restarting backend service..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" << ENDSSH
            set -e
            
            echo "üìä Current service status:"
            sudo systemctl status langchain-backend --no-pager -l | head -n 10 || true
            
            echo ""
            echo "‚ôªÔ∏è  Restarting service..."
            sudo systemctl restart langchain-backend
            
            echo "‚è≥ Waiting for service to start (10 seconds)..."
            sleep 10
            
            if sudo systemctl is-active --quiet langchain-backend; then
              echo "‚úÖ Backend service restarted successfully"
              echo ""
              echo "üìã Service status:"
              sudo systemctl status langchain-backend --no-pager -l | head -n 15
              echo ""
              echo "üìã Recent logs (last 20 lines):"
              sudo journalctl -u langchain-backend --no-pager -n 20
            else
              echo "‚ùå Backend service restart failed"
              echo ""
              echo "üìã Error logs:"
              sudo journalctl -u langchain-backend --no-pager -n 50
              exit 1
            fi
            
            echo ""
            echo "üîå Checking port 8000:"
            PORT_CHECK=\$(sudo netstat -tlnp 2>/dev/null | grep :8000 || sudo ss -tlnp 2>/dev/null | grep :8000 || echo "")
            if [ -z "\$PORT_CHECK" ]; then
              echo "‚ùå Port 8000 is not bound"
              exit 1
            else
              echo "‚úÖ Port 8000 is in use:"
              echo "\$PORT_CHECK"
            fi
            
            echo ""
            echo "üè• Health check:"
            HEALTH_RESPONSE=\$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || echo "000")
            if [ "\$HEALTH_RESPONSE" = "200" ]; then
              echo "‚úÖ Health check successful (HTTP \$HEALTH_RESPONSE)"
            else
              echo "‚ö†Ô∏è  Health check response: HTTP \$HEALTH_RESPONSE"
            fi
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment succeeded"
          else
            echo "‚ùå Deployment failed"
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

